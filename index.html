<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wuliao — 物料管理</title>
<style>
  /* 根变量定义：方便统一修改应用配色和尺寸 */
  :root{
    --primary: #1976d2;        /* 主题色：用于顶部栏和抽屉头部 */
    --surface: #ffffff;        /* 表面色：用于抽屉、卡片、表格背景 */
    --muted: #f5f5f5;          /* 柔和色：用于主要内容区域背景 */
    --accent: #ffb300;         /* 强调色：当前未使用，可作为突出颜色 */
    --text: #222;              /* 默认文本颜色 */
    --drawer-width: 180px;     /* 侧边抽屉的宽度 */
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; color:var(--text);}
  .app{display:flex;height:100vh;overflow:hidden;}
  /* 侧边抽屉样式 */
  .drawer{position:fixed;left:0;top:0;bottom:0;width:var(--drawer-width);background:var(--surface);box-shadow:2px 0 8px rgba(0,0,0,.08);transform:translateX(-110%);transition:transform .22s ease; z-index:1000;}
  .drawer.open{transform:translateX(0)} /* 抽屉打开时，移动到可视区 */
  .drawer .header{padding:60px;background:linear-gradient(90deg,var(--primary),#2196f3);color:#fff} /* 抽屉头部背景渐变 */
  .drawer nav{display:flex;flex-direction:column;padding:8px}
  .drawer nav button{background:none;border:none;text-align:left;padding:12px 16px;border-radius:6px;margin:4px 8px;color:var(--text);cursor:pointer}
  .drawer nav button.active{background:rgba(0,0,0,.06)} /* 当前选中导航项的背景色 */
  /* 遮罩层样式 */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.34);opacity:0;visibility:hidden;transition:opacity .2s; z-index:900;}
  .overlay.show{opacity:1;visibility:visible} /* 遮罩层显示时 */
  /* 顶部栏 */
  .main{flex:1;display:flex;flex-direction:column;min-width:0}
  .topbar{display:flex;align-items:center;padding:10px 12px;background:var(--primary);color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .hamburger{width:36px;height:36px;border-radius:6px;background:transparent;border:none;color:white;font-size:20px;margin-right:8px;cursor:pointer}
  .title{font-weight:600;font-size:18px}
  /* 内容区域 */
  .content{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--muted)}
  .page{flex:1;overflow:auto;padding:12px}
  /* 物料按钮网格 */
  .grid{
    display:grid;
    grid-template-columns:repeat(3,1fr); /* 每行 3 列，平均分配宽度 */
    gap:8px; /* 网格间距 */
  }
  .grid .item{
    min-height:64px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    color:#000;
    font-weight:600;
    box-shadow:0 1px 2px rgba(0,0,0,.05);
    cursor:pointer;
  }
  /* 按钮通用样式 */
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;background:#eee;border:none;cursor:pointer}
  /* 记录表格 */
  .table{width:100%;border-collapse:collapse}
  .table thead td{font-weight:700;padding:8px;background:#fff;border-bottom:1px solid #ddd}
  .table tbody tr td{padding:8px;background:#fff;border-bottom:1px solid #eee}
  /* 汇总行 */
  .summary-row{display:flex;align-items:center;padding:8px;background:#fff;margin-bottom:6px;border-radius:6px}
  .summary-row .name{flex:1}
  .summary-row .value{width:120px;text-align:center;font-weight:700}
  /* 配置页面 */
  .config-top{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .config-top select{flex:3;padding:8px;border-radius:6px;border:1px solid #ccc}
  .config-top button{flex:1;padding:8px;border-radius:6px}
  textarea#configText{width:100%;height:60vh;padding:10px;border-radius:8px;border:1px solid #ddd;resize:vertical;background:#fff}
</style>

</style>
</head>
<body>
<div class="app">
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="header">
      <div style="font-size:18px;font-weight:700">Wuliao</div>
      <div style="font-size:12px;opacity:.9">物料管理（Web 版）</div>
      <div style="font-size:12px;opacity:.9">hxf6276&ChatGPT</div>
    </div>
    <nav id="navlist" role="navigation" aria-label="主导航">
      <button data-page="materials" id="nav_materials" class="active">物料名称</button>
      <button data-page="records" id="nav_records">记录区</button>
      <button data-page="summary" id="nav_summary">汇总记录</button>
      <button data-page="config" id="nav_config">配置</button>
    </nav>
  </div>

  <div id="overlay" class="overlay"></div>

  <div class="main">
    <div class="topbar">
      <button id="hamburger" class="hamburger" aria-label="打开菜单">☰</button>
      <div class="title">物料管理</div>
    </div>

    <div class="content">
      <section id="page_materials" class="page" aria-hidden="false">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">物料按钮面板</div>
          <div style="font-size:12px;color:#555">每行 3 个，长按暂以双击替代（移动端长触）</div>
        </div>
        <div id="materialsGrid" class="grid" aria-live="polite"></div>
        <div style="height:60px;"></div>
        <div id="materialsFixedBar" style="position:fixed; bottom:0; left:0; width:100%; background:#fff; border-top:1px solid #ddd; padding:12px; z-index:50;">
            <button id="btnAddMaterial" class="btn" style="width:100%;">+ 新增按钮</button>
        </div>
      </section>

      <section id="page_records" class="page" aria-hidden="true" style="display:none">
        <div style="font-weight:700;margin-bottom:8px">操作记录</div>
        <div id="recordsArea">
          <table class="table" aria-describedby="记录表">
            <thead><tr><td>物料名称</td><td>数量</td><td>时间</td></tr></thead>
            <tbody id="recordsTbody"></tbody>
          </table>
          <div id="recordsFixedBar" style="position:fixed; bottom:0; left:0; width:100%; display:flex; background:#fff; border-top:1px solid #ddd; padding:8px 0; z-index:50;">
              <button id="btnClearRecords" class="btn" style="width:50%;">清空当前记录</button>
              <button id="btnExportRecords" class="btn" style="width:50%;">导出为CSV</button>
          </div>
        </div>
      </section>

      <section id="page_summary" class="page" aria-hidden="true" style="display:none">
        <div style="font-weight:700;margin-bottom:8px">汇总记录</div>
        <div id="summaryArea"></div>
      </section>

      <section id="page_config" class="page" aria-hidden="true" style="display:none">
        <div style="font-weight:700;margin-bottom:8px">配置文件</div>
        <div class="config-top">
          <select id="configSelect" aria-label="配置文件列表"></select>
          <input type="file" id="configFileInput" accept=".txt,.json,.conf,.cfg,.ini,.yaml,.yml,.csv,.conf,.ini,.xml,.html,.htm,.js,.py,.md,.log,.bat,.sh,.tsv" style="display:none" />
          <button id="btnChooseFile" class="btn">本地配置</button>
          <button id="btnNewConfig" class="btn">新增配置</button>
        </div>
        <textarea id="configText" placeholder="配置文件内容：每行 格式为：物料名称「」#RRGGBB"></textarea>
        <div style="margin-top:8px;font-size:12px;color:#666">示例行：螺丝「」#FFCDD2</div>
        <div id="configFixedBar" style="position:fixed; bottom:0; left:0; width:100%; background:#fff; border-top:1px solid #ddd; padding:12px; z-index:50; display:flex; gap:8px;">
          <button id="btnSaveConfigFile" class="btn" style="flex:1;">保存当前配置到本地</button>
          <button id="btnDeleteConfigFile" class="btn" style="flex:1; background:#F44336; color:#fff;">删除当前配置文件</button>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
/*
  Wuliao Web App 物料管理 Web 版
  数据存储机制：全部使用 localStorage 存储在浏览器本地
    - key: wuliao_configs -> { filename: contentString, ... } 存储所有配置文件内容
    - key: wuliao_current -> filename 存储当前选中的配置文件名
    - key: wuliao_records -> [ {name, quantity, time}, ... ] 存储所有操作记录
*/
(function(){
  // --- 基础工具函数 (Utilities) ---
  function $(sel, ctx){ return (ctx||document).querySelector(sel); }             // 快捷选择单个元素
  function $all(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); } // 快捷选择所有元素并转为数组
  function nowTime(){ const d=new Date(); return d.toTimeString().split(' ')[0]; } // 获取当前时间（HH:MM:SS）
  function persist(key, val){ localStorage.setItem(key, JSON.stringify(val)); } // 存储数据到 localStorage (自动JSON化)
  function load(key, fallback){ try{ const s=localStorage.getItem(key); return s?JSON.parse(s):fallback; }catch(e){return fallback;} } // 从 localStorage 读取数据 (自动解析JSON)
  
  // 确保默认配置文件存在，并尝试从网络加载
  function ensureDefaultConfigs(){
      let configs = load('wuliao_configs', null);
      if(!configs){
        configs = {};
        persist('wuliao_configs', configs);
      }
      let current = load('wuliao_current', null);

      // 尝试从 GitHub 获取默认配置文件（网络功能）
      fetch('https://raw.githubusercontent.com/hxf6276/wuliao-net/main/configs/default.txt')
        .then(resp=>{
            if(!resp.ok) throw new Error('GitHub 文件获取失败');
            return resp.text();
        })
        .then(text=>{
            // 成功：保存为“默认配置”并设置为当前配置
            configs['默认配置'] = text;
            persist('wuliao_configs', configs);
            persist('wuliao_current', '默认配置');
            renderMaterials();
            renderConfigEditor();
            // ... (省略加载成功的UI提示逻辑) ...
        })
        .catch(err=>{
            console.error('读取 GitHub 默认配置失败', err);
            // 失败：使用本地内置的默认配置
            if(!configs['默认配置']){
                configs['默认配置'] = "物料A「」#FFCDD2\n物料B「」#C8E6C9\n物料C「」#BBDEFB\n";
                persist('wuliao_configs', configs);
            }
            // 设置当前配置为已有的配置或默认配置
            persist('wuliao_current', Object.keys(configs)[0]);
            renderMaterials();
            renderConfigEditor();
        });
      // 确保记录数组已初始化
      if(!localStorage.getItem('wuliao_records')){
        persist('wuliao_records', []);
      }
  }

  // --- UI 元素引用 (DOM References) ---
  const drawer = $('#drawer'), overlay = $('#overlay'), hamburger=$('#hamburger');
  const navButtons = $all('#navlist button');
  const pages = { // 页面集合
    materials: $('#page_materials'),
    records: $('#page_records'),
    summary: $('#page_summary'),
    config: $('#page_config')
  };
  const materialsGrid = $('#materialsGrid'); // 物料按钮容器
  const btnAddMaterial = $('#btnAddMaterial');
  const recordsTbody = $('#recordsTbody'); // 记录表格体
  const summaryArea = $('#summaryArea'); // 汇总区域
  const configSelect = $('#configSelect'); // 配置下拉选择框
  const configText = $('#configText');     // 配置文本编辑区
  const btnNewConfig = $('#btnNewConfig'); // 新增配置按钮
  
  // 新增的配置相关DOM
  const configFileInput = document.getElementById('configFileInput');
  const btnChooseFile = document.getElementById('btnChooseFile');
  const btnDeleteConfigFile = document.getElementById('btnDeleteConfigFile');
  

  // --- 抽屉和导航控制逻辑 (Navigation Control) ---
  function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }
  hamburger.addEventListener('click', ()=>{ openDrawer(); });
  overlay.addEventListener('click', ()=> closeDrawer());
  
  // 导航切换
  navButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      navButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const page = btn.getAttribute('data-page');
      showPage(page);
      closeDrawer();
    });
  });

  // 显示指定页面
  function showPage(name){
    Object.keys(pages).forEach(k=>{
      if(k===name){ pages[k].style.display='block'; pages[k].setAttribute('aria-hidden','false'); }
      else{ pages[k].style.display='none'; pages[k].setAttribute('aria-hidden','true'); }
    });
    // 切换页面时刷新内容
    if(name==='materials') renderMaterials();
    if(name==='records') renderRecords();
    if(name==='summary') renderSummary();
    if(name==='config') renderConfigEditor();
  }

  // --- 配置内容解析 (Config Parser) ---
  // 将配置文本内容解析为 [{name, color}, ...] 数组
  function parseConfigContent(content){
    const lines = (content||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean); // 按行分割，去除空行
    const items=[];
    for(const line of lines){
      if(line.indexOf('「」')>-1){ // 优先使用 物料名「」#颜色 格式
        const parts = line.split('「」');
        if(parts.length>=2){
          items.push({name:parts[0].trim(),color:parts.slice(1).join('「」').trim()});
        }
      } else {
        // 兼容旧格式或简单格式：物料名#颜色
        const idx = line.lastIndexOf('#');
        if(idx>-1){
          const name = line.slice(0, idx).trim();
          const color = '#'+line.slice(idx+1).trim().replace(/^#+/,'');
          items.push({name:name||'无名', color: color});
        } else {
          // 只有名称
          items.push({name:line, color:'#CCCCCC'});
        }
      }
    }
    return items;
  }

  // --- 物料面板渲染 (Materials Rendering) ---
  function renderMaterials(){
    materialsGrid.innerHTML='';
    const configs = load('wuliao_configs', {});
    const cur = load('wuliao_current', Object.keys(configs)[0]);
    const content = configs[cur] || '';
    const items = parseConfigContent(content); // 获取当前配置的物料列表
    
    items.forEach((it, idx)=>{
      const div = document.createElement('div');
      div.className='item';
      div.textContent = it.name;
      
      // 解析并设置按钮颜色
      try{
        let c = it.color||'#CCCCCC';
        if(!c.startsWith('#')) c = '#'+c;
        if(/^#[0-9A-Fa-f]{6}$/.test(c) || /^#[0-9A-Fa-f]{8}$/.test(c)){
          div.style.background = c;
        } else {
          div.style.background = '#CCCCCC';
        }
      }catch(e){ div.style.background='#CCCCCC'; }
      
      // 点击事件：弹出自定义数字键盘对话框
      div.addEventListener('click', ()=>{
          // 1. 移除已存在的键盘，防止重复
          const existingDlg = document.getElementById('numPadDialog');
          if(existingDlg) existingDlg.remove();

          // 2. 创建对话框容器并设置样式
          const dlgWidth = window.innerWidth * 0.8;
          const dlg = document.createElement('div');
          dlg.id = 'numPadDialog';
          // 设置固定居中样式
          dlg.style.position='fixed'; dlg.style.top='50%'; dlg.style.left='50%';
          dlg.style.transform='translate(-50%,-50%)';
          dlg.style.background='#fff'; dlg.style.padding='16px';
          dlg.style.border='1px solid #ccc'; dlg.style.borderRadius='8px';
          dlg.style.zIndex=2000; dlg.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)';
          dlg.style.display='flex'; dlg.style.flexDirection='column'; dlg.style.alignItems='center';
          dlg.style.width = dlgWidth + 'px'; dlg.style.maxWidth = '95vw';

          // 3. 添加标题
          const title = document.createElement('div');
          title.textContent = it.name;
          title.style.fontSize='20px'; title.style.fontWeight='700'; title.style.marginBottom='12px';
          dlg.appendChild(title);

          // 4. 输入显示区域 + 删除按钮 (新布局)
          const displayWrap = document.createElement('div');
          displayWrap.style.display = 'flex'; displayWrap.style.alignItems = 'center';
          displayWrap.style.marginBottom = '12px'; displayWrap.style.width = '100%';

          const display = document.createElement('div');
          display.style.fontSize='24px'; display.style.flex='1'; display.style.paddingRight='10px';
          display.style.textAlign='right'; 
          display.textContent = '0'; // 初始显示 0

          // 删除/退格按钮
          const delBtn = document.createElement('button');
          delBtn.textContent = '⌫'; 
          delBtn.style.fontSize = '20px'; delBtn.style.padding = '8px 12px'; delBtn.style.marginLeft = '8px';
          delBtn.style.background = '#F44336'; delBtn.style.color = '#fff';
          delBtn.style.border = 'none'; delBtn.style.borderRadius = '6px'; delBtn.style.cursor = 'pointer';

          displayWrap.appendChild(display);
          displayWrap.appendChild(delBtn);
          dlg.appendChild(displayWrap);

          let currentVal = ''; // 当前输入值（字符串）

          // 统一更新显示内容的函数
          function updateDisplay(val) {
              display.textContent = val === '' ? '0' : val;
          }

          // 5. 创建数字按钮网格
          const btnContainer = document.createElement('div');
          btnContainer.style.display='grid';
          btnContainer.style.gridTemplateColumns = `repeat(3, 1fr)`; // 3 列布局
          btnContainer.style.gridGap='8px';
          btnContainer.style.marginBottom='12px';
          btnContainer.style.width = '100%';

          // 键盘布局： 1-9, 然后是 "-", "0", "."
          const numbers = ['1','2','3','4','5','6','7','8','9','-','0','.'];
          numbers.forEach(char=>{
              const b = document.createElement('button');
              b.textContent = char;
              b.style.width = '100%';
              b.style.height = `${window.innerHeight/10}px`; 
              b.style.fontSize = '20px';
              b.style.border = '1px solid #ddd';
              b.style.borderRadius = '6px';
              
              if(char === '-' || char === '.'){
                  b.style.background = '#E0E0E0'; // 特殊功能键颜色
              }

              // 按钮点击处理逻辑
              b.addEventListener('click', ()=>{
                  let newVal = currentVal;
                  
                  if (char === '-') {
                    // 负号逻辑：只能在开头，且只能有一个
                    if (currentVal.includes('-')) return;
                    if (currentVal === '') {
                        newVal = '-';
                    }
                  } else if (char === '.') {
                    // 小数点逻辑：只能有一个
                    if (currentVal.includes('.')) return;
                    // 如果是空或只有'-'，自动补充'0'，形成 '0.' 或 '-0.'
                    if (currentVal === '' || currentVal === '-') {
                        newVal += '0.';
                    } else {
                        newVal += '.';
                    }
                  } else {
                    // 数字输入逻辑
                    if (currentVal === '0') {
                        newVal = char; // 替换单个'0'
                    } else if (currentVal === '-0') {
                        newVal = '-' + char; // 替换 '-0'
                    } else {
                        newVal += char; // 正常累加
                    }
                  }

                  currentVal = newVal;
                  updateDisplay(currentVal);
              });
              btnContainer.appendChild(b);
          });

          // 删除按钮的点击逻辑
          delBtn.addEventListener('click', ()=>{
            if (currentVal.length > 0) {
              currentVal = currentVal.slice(0, -1); // 截取掉最后一个字符
            }
            updateDisplay(currentVal);
          });

          dlg.appendChild(btnContainer);

          // 6. 确定和取消按钮
          const btnContainerBottom = document.createElement('div');
          btnContainerBottom.style.display='flex'; btnContainerBottom.style.width='100%'; btnContainerBottom.style.marginTop='8px';

          const btnOk = document.createElement('button');
          btnOk.textContent='确定';
          btnOk.style.flex='1'; btnOk.style.backgroundColor='#4CAF50'; btnOk.style.color='#fff';
          btnOk.style.padding='12px'; btnOk.style.fontSize='18px'; btnOk.style.border='none'; btnOk.style.borderRadius='6px';
          
          // 确定按钮点击逻辑：校验、添加记录
          btnOk.addEventListener('click', ()=>{
              let val = currentVal;
              // 最终校验无效输入
              if (val === '' || val === '-' || val === '.' || val === '-.') {
                alert('请输入有效数字');
                return;
              }
              // 修正例如 '.5' 为 '0.5' 的情况
              if (val.startsWith('.')) {
                  val = '0' + val;
              }
              const n = parseFloat(val);
              if(isNaN(n)){ alert('请输入有效数字'); return; }
              
              addRecord(it.name,n); // 记录操作
              renderRecords();
              renderSummary();
              dlg.remove();
          });

          const btnCancel = document.createElement('button');
          btnCancel.textContent='取消';
          btnCancel.style.flex='1'; btnCancel.style.backgroundColor='#F44336'; btnCancel.style.color='#fff';
          btnCancel.style.padding='12px'; btnCancel.style.fontSize='18px'; btnCancel.style.border='none'; btnCancel.style.borderRadius='6px';
          btnCancel.style.marginLeft='8px';
          
          // 取消按钮点击逻辑：关闭对话框
          btnCancel.addEventListener('click', ()=>dlg.remove());

          btnContainerBottom.appendChild(btnOk);
          btnContainerBottom.appendChild(btnCancel);
          dlg.appendChild(btnContainerBottom);

          document.body.appendChild(dlg); // 将对话框添加到页面
      });
      
      // 双击/长按事件：编辑物料
      div.addEventListener('dblclick', ()=>{ editMaterialDialog(it, idx); });
      addLongPress(div, ()=>{ editMaterialDialog(it, idx); });
      materialsGrid.appendChild(div);
    });
  }

  // 长按辅助函数 (适用于移动设备)
  function addLongPress(el, callback, ms=700){
    let timer=null;
    el.addEventListener('touchstart', (e)=>{ timer=setTimeout(()=>{ callback(); }, ms); }, {passive:true});
    el.addEventListener('touchend', ()=>{ if(timer) clearTimeout(timer); }, {passive:true});
    el.addEventListener('mousedown', ()=>{ timer=setTimeout(()=>{ callback(); }, ms); });
    el.addEventListener('mouseup', ()=>{ if(timer) clearTimeout(timer); });
    el.addEventListener('mouseleave', ()=>{ if(timer) clearTimeout(timer); });
  }

  // 编辑物料对话框：修改名称/颜色/删除
  function editMaterialDialog(item, index){
    const configs = load('wuliao_configs', {});
    const cur = load('wuliao_current', Object.keys(configs)[0]);
    const content = configs[cur] || '';
    const items = parseConfigContent(content);
    if(!items[index]) { alert('物料不存在'); return; }
    
    const name = prompt('修改物料名称：', items[index].name);
    if(name===null) return;
    const color = prompt('修改颜色（#RRGGBB）：', items[index].color||'#FFFFFF');
    if(color===null) return;
    
    const del = confirm('要删除该按钮吗？点确定删除，否则保存修改。');
    if(del){
      items.splice(index,1); // 删除该物料
    } else {
      items[index].name = name.trim()||items[index].name;
      items[index].color = (color.trim().startsWith('#')?color.trim():('#'+color.trim()));
    }
    
    // 重建配置文件内容并保存
    const newContent = items.map(it=>`${it.name}「」${it.color}`).join('\n') + '\n';
    configs[cur] = newContent;
    persist('wuliao_configs', configs);
    renderMaterials();
  }

  // 新增物料按钮逻辑
  $('#btnAddMaterial').addEventListener('click', ()=>{
    const name = prompt('新建物料名称：','新物料');
    if(name===null) return;
    
    const configs = load('wuliao_configs', {});
    const cur = load('wuliao_current', Object.keys(configs)[0]);
    const content = configs[cur] || '';
    
    const items = parseConfigContent(content);
    if(items.some(it => it.name === name.trim())){
      alert('物料名称已存在，不能重复添加！');
      return;
    }
    
    const color = prompt('颜色(#RRGGBB)：','#FFFFFF');
    if(color===null) return;
    
    // 将新物料追加到当前配置文件的末尾
    configs[cur] = (configs[cur]||'') + `${name.trim()}「」${(color.trim().startsWith('#')?color.trim():('#'+color.trim()))}\n`;
    persist('wuliao_configs', configs);
    renderMaterials();
  });

  // --- 记录区逻辑 (Records Logic) ---
  // 添加一条新的记录
  function addRecord(name, quantity){
    const records = load('wuliao_records', []);
    records.unshift({name, quantity, time: nowTime()}); // 记录添加到数组开头
    persist('wuliao_records', records);
  }

  // 渲染记录表格
  function renderRecords(){
    const records = load('wuliao_records', []);
    recordsTbody.innerHTML='';
    records.forEach((r, idx)=>{
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = r.name;
      const td2 = document.createElement('td'); td2.textContent = r.quantity;
      const td3 = document.createElement('td'); td3.textContent = r.time;
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
      
      // 绑定长按/右键菜单事件
      let timer = null;
      const longPressMs = 700;
      tr.addEventListener('touchstart', (e)=>{ timer=setTimeout(()=>{ showRecordContextMenu(idx, tr); }, longPressMs); }, {passive:true});
      tr.addEventListener('touchend', ()=>{ if(timer) clearTimeout(timer); }, {passive:true});
      tr.addEventListener('mousedown', (e)=>{ if(e.button===0) timer=setTimeout(()=>{ showRecordContextMenu(idx, tr); }, longPressMs); });
      tr.addEventListener('mouseup', ()=>{ if(timer) clearTimeout(timer); });
      tr.addEventListener('mouseleave', ()=>{ if(timer) clearTimeout(timer); });
      tr.addEventListener('contextmenu', (e)=>{ e.preventDefault(); showRecordContextMenu(idx, tr, e); });
      
      recordsTbody.appendChild(tr);
    });
  }

  // 显示记录行的上下文菜单（修改/删除）
  function showRecordContextMenu(idx, tr, event){
    // ... (上下文菜单创建和事件逻辑，与原代码一致，略) ...
    let oldMenu = document.getElementById('recordContextMenu');
    if(oldMenu) oldMenu.remove();
    const menu = document.createElement('div');
    menu.id = 'recordContextMenu';
    menu.style.position = 'fixed';
    menu.style.background = '#fff';
    menu.style.border = '1px solid #ccc';
    menu.style.borderRadius = '6px';
    menu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
    menu.style.zIndex = 3000;
    menu.style.padding = '0';
    menu.style.minWidth = '160px';
    menu.style.fontSize = '16px';
    let x = 0, y = 0;
    if(event && event.clientX !== undefined){
      x = event.clientX;
      y = event.clientY;
    } else {
      const rect = tr.getBoundingClientRect();
      x = rect.left + rect.width/2;
      y = rect.top + rect.height/2;
    }
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;

    const btnDel = document.createElement('div');
    btnDel.textContent = '删除当前选中行';
    btnDel.style.padding = '12px';
    btnDel.style.cursor = 'pointer';
    btnDel.addEventListener('click', ()=>{
      let records = load('wuliao_records', []);
      records.splice(idx, 1);
      persist('wuliao_records', records);
      renderRecords();
      renderSummary();
      menu.remove();
    });

    const btnEdit = document.createElement('div');
    btnEdit.textContent = '修改当前行的数字';
    btnEdit.style.padding = '12px';
    btnEdit.style.cursor = 'pointer';
    btnEdit.addEventListener('click', ()=>{
      let records = load('wuliao_records', []);
      let oldVal = records[idx]?.quantity;
      let newVal = prompt('请输入新的数字：', oldVal);
      if(newVal !== null){
        if(isNaN(parseFloat(newVal))){
          alert('请输入有效数字');
        } else {
          records[idx].quantity = parseFloat(newVal);
          persist('wuliao_records', records);
          renderRecords();
          renderSummary();
        }
      }
      menu.remove();
    });

    [btnDel, btnEdit].forEach(btn=>{
      btn.addEventListener('mouseenter', ()=>{btn.style.background='#f5f5f5';});
      btn.addEventListener('mouseleave', ()=>{btn.style.background='#fff';});
    });
    menu.appendChild(btnDel);
    menu.appendChild(btnEdit);
    
    function removeMenu(e){
      if(!menu.contains(e.target)){ menu.remove(); document.removeEventListener('mousedown', removeMenu); }
    }
    setTimeout(()=>{ document.addEventListener('mousedown', removeMenu); }, 0);
    document.body.appendChild(menu);
  }

  // 清空所有记录
  $('#btnClearRecords')?.addEventListener('click', ()=>{
    if(!confirm('确定要清空所有记录吗？')) return;
    persist('wuliao_records', []);
    renderRecords();
    renderSummary();
  });

  // 导出记录为 CSV
  $('#btnExportRecords')?.addEventListener('click', ()=>{
    const records = load('wuliao_records', []);
    if(records.length === 0){ alert('当前没有记录可导出'); return; }
    
    let csv = '物料名称,数量,时间\n';
    records.forEach(r=>{ csv += `${r.name},${r.quantity},${r.time}\n`; });
    
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '记录导出.csv'; // 默认文件名
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // --- 汇总区逻辑 (Summary Logic) ---
  // 渲染汇总表格
  function renderSummary(){
    const records = load('wuliao_records', []);
    const map = {}; // {物料名: 总数量}
    for(const r of records){
      map[r.name] = (map[r.name]||0) + Number(r.quantity);
    }
    summaryArea.innerHTML='';
    for(const k of Object.keys(map)){
      const div = document.createElement('div');
      div.className='summary-row';
      const nameDiv = document.createElement('div'); nameDiv.className='name'; nameDiv.textContent = k;
      const valDiv = document.createElement('div'); valDiv.className='value'; valDiv.textContent = map[k];
      div.appendChild(nameDiv); div.appendChild(valDiv);
      summaryArea.appendChild(div);
    }
  }

  // --- 配置编辑区逻辑 (Config Editor Logic) ---
  // 渲染配置下拉框和内容
  function renderConfigEditor(){
    const configs = load('wuliao_configs', {});
    configSelect.innerHTML='';
    
    const allKeys = Object.keys(configs);
    let keys = [];
    if (allKeys.includes('默认配置')) { keys.push('默认配置'); } // 确保默认配置在第一个
    keys = keys.concat(allKeys.filter(k => k !== '默认配置').sort()); // 其他配置按字母排序
    
    keys.forEach(fn=>{
      const o = document.createElement('option'); o.value=fn; o.textContent=fn; configSelect.appendChild(o);
    });
    
    const current = load('wuliao_current', keys[0]);
    if(current && configSelect.querySelector(`option[value="${current}"]`)){
      configSelect.value = current;
    } else {
      configSelect.selectedIndex = 0;
      persist('wuliao_current', configSelect.value);
    }
    loadConfigTextToEditor();
  }

  // 加载当前选中的配置内容到文本框
  function loadConfigTextToEditor(){
    const configs = load('wuliao_configs', {});
    const cur = configSelect.value;
    configText.value = configs[cur] || '';
  }

  // 将文本框内容保存到当前配置
  function saveEditorToConfig(){
    const configs = load('wuliao_configs', {});
    const cur = configSelect.value;
    configs[cur] = configText.value;
    persist('wuliao_configs', configs);
    renderMaterials(); // 实时更新物料面板
  }

  // 新增配置按钮
  btnNewConfig.addEventListener('click', ()=>{
    const name = prompt('新配置文件名（含或不含 .txt）：','新配置.txt');
    if(!name) return;
    let fn = name.trim();
    if(!fn.endsWith('.txt')) fn += '.txt';
    
    const configs = load('wuliao_configs', {});
    if(configs[fn]){ alert('文件已存在'); return; }
    
    configs[fn]=''; // 创建空配置
    persist('wuliao_configs', configs);
    persist('wuliao_current', fn);
    
    renderConfigEditor();
    configSelect.value = fn;
    configText.value = '';
    configText.focus();
  });

  // 绑定配置下拉框变化事件：切换配置
  configSelect.addEventListener('change', ()=>{
    const selected = configSelect.value;
    persist('wuliao_current', selected);
    loadConfigTextToEditor();
    renderMaterials(); // 切换配置后，刷新物料面板
  });
  
  // 绑定“保存当前配置到本地”按钮（导出功能）
  $('#btnSaveConfigFile').addEventListener('click', ()=>{
      const content = configText.value;
      const fileName = configSelect.value || '配置导出.txt';
      const blob = new Blob([content], {type:'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert(`配置 "${fileName}" 已导出到您的设备。`);
  });

  // 文本输入防抖保存
  let saveTimer = null;
  configText.addEventListener('input', ()=>{
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      saveEditorToConfig();
    }, 500); // 停止输入 0.5 秒后自动保存
  });

  // --- 初始化与启动 ---
  ensureDefaultConfigs();
  renderMaterials();
  renderRecords();
  renderSummary();
  renderConfigEditor();
  showPage('materials'); // 默认显示物料面板

  // 键盘 Esc 键关闭抽屉
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape') closeDrawer();
  });

  // --- 新增功能逻辑 ---

  // 绑定“本地配置”按钮，触发文件选择
  btnChooseFile.addEventListener('click', () => {
      configFileInput.click();
  });

  // 处理文件选择后的导入事件
  configFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
          const content = event.target.result;
          const fileName = file.name;
          
          let configs = load('wuliao_configs', {});
          
          // 提示是否覆盖已存在的文件
          if (configs[fileName] && !confirm(`文件 ${fileName} 已存在，是否覆盖？`)) {
              configFileInput.value = ''; 
              return;
          }

          configs[fileName] = content;
          persist('wuliao_configs', configs);
          persist('wuliao_current', fileName); // 导入后自动切换到该配置

          renderConfigEditor();
          configSelect.value = fileName; 
          configText.value = content;     
          renderMaterials();             

          alert(`配置文件 ${fileName} 导入成功！`);
          configFileInput.value = ''; // 清空选择，允许下次继续选择同名文件
      };
      
      if (file.size > 1024 * 1024 * 5) { // 限制为5MB
          alert('文件太大，请选择小于 5MB 的配置文件。');
          configFileInput.value = '';
          return;
      }
      reader.readAsText(file, 'UTF-8'); // 以文本方式读取
  });

  // 删除当前配置文件的逻辑
  btnDeleteConfigFile.addEventListener('click', () => {
    const cur = configSelect.value;
    
    if (cur === '默认配置') {
        alert('不能删除默认配置文件。');
        return; // 阻止删除默认配置
    }
    
    if (!cur) {
        alert('当前没有选中的配置文件。');
        return;
    }

    if (!confirm(`确定要删除配置文件 "${cur}" 吗？该操作不可逆！`)) {
        return;
    }

    let configs = load('wuliao_configs', {});
    
    // 1. 从存储中删除该配置
    delete configs[cur];
    persist('wuliao_configs', configs);

    // 2. 切换当前配置
    const remainingKeys = Object.keys(configs);
    let newCurrent = '默认配置';
    if (remainingKeys.length > 0) {
        // 确保切换到默认配置或剩下的第一个配置
        newCurrent = remainingKeys.includes('默认配置') ? '默认配置' : remainingKeys.sort()[0];
    } 
    
    persist('wuliao_current', newCurrent);

    // 3. 重新渲染UI
    renderConfigEditor();
    renderMaterials();
    
    alert(`配置文件 "${cur}" 已删除，已切换到 "${newCurrent}"。`);
  });
})();
</script>
